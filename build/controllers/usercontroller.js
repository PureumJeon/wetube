"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));require("core-js/modules/es6.object.define-property"),Object.defineProperty(exports,"__esModule",{value:!0}),exports.postChangePassword=exports.getChangePassword=exports.postEditProfile=exports.getEditProfile=exports.userDetail=exports.getMe=exports.logout=exports.postKakaoLogin=exports.kakaoLoginCallback=exports.kakaoLogin=exports.postGithubLogin=exports.githubLoginCallback=exports.githubLogin=exports.postLogin=exports.getLogin=exports.postJoin=exports.getJoin=void 0;require("core-js/modules/es6.function.name"),require("regenerator-runtime/runtime");var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),_passport=_interopRequireDefault(require("passport")),_routes=_interopRequireDefault(require("../routes")),_User=_interopRequireDefault(require("../models/User")),getJoin=function(a,b){b.render("join",{pageTitle:"Join"})};exports.getJoin=getJoin;var postJoin=/*#__PURE__*/function(){var a=(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function a(b,c,d){var e,f,g,h,i,j;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(e=b.body,f=e.name,g=e.email,h=e.password,i=e.password2,h===i){a.next=6;break}c.status(400),c.render("join",{pageTitle:"Join"}),a.next=19;break;case 6:return a.prev=6,a.next=9,(0,_User["default"])({name:f,email:g});case 9:return j=a.sent,a.next=12,_User["default"].register(j,h);case 12:d(),a.next=19;break;case 15:a.prev=15,a.t0=a["catch"](6),console.log(a.t0),c.redirect(_routes["default"].home);case 19:case"end":return a.stop();}},a,null,[[6,15]])}));return function(){return a.apply(this,arguments)}}();exports.postJoin=postJoin;var getLogin=function(a,b){return b.render("login",{pageTitle:"Login"})};exports.getLogin=getLogin;var postLogin=_passport["default"].authenticate("local",{failureRedirect:_routes["default"].login,successRedirect:_routes["default"].home});exports.postLogin=postLogin;var githubLogin=_passport["default"].authenticate("github");exports.githubLogin=githubLogin;var githubLoginCallback=/*#__PURE__*/function(){var a=(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function a(b,c,d,e){var f,g,h,i,j,k,l;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return f=d._json,g=f.id,h=f.avatar_url,i=f.name,j=f.email,console.log(d),a.prev=2,a.next=5,_User["default"].findOne({email:j});case 5:if(k=a.sent,!k){a.next=10;break}return k.githubId=g,k.save(),a.abrupt("return",e(null,k));case 10:return a.next=12,_User["default"].create({email:j,name:i,githubId:g,avatarUrl:h});case 12:return l=a.sent,a.abrupt("return",e(null,l));case 16:return a.prev=16,a.t0=a["catch"](2),a.abrupt("return",e(a.t0));case 19:case"end":return a.stop();}},a,null,[[2,16]])}));return function(){return a.apply(this,arguments)}}();exports.githubLoginCallback=githubLoginCallback;var postGithubLogin=function(a,b){b.redirect(_routes["default"].home)};//kakao
exports.postGithubLogin=postGithubLogin;var kakaoLogin=_passport["default"].authenticate("kakao");exports.kakaoLogin=kakaoLogin;var kakaoLoginCallback=/*#__PURE__*/function(){var a=(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function a(b,c,d,e){var f,g,h,i,j,k,l,m,n;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return f=d._json,g=f.id,h=f.properties,i=f.kakao_account,j=h.nickname,k=h.profile_image,l=i.email,console.log(g,h.nickname,h.profile_image,i.email),a.prev=5,a.next=8,_User["default"].findOne({email:l});case 8:if(m=a.sent,!m){a.next=13;break}return m.kakaoId=g,m.save(),a.abrupt("return",e(null,m));case 13:return a.next=15,_User["default"].create({email:l,name:j,kakaoId:g,avatarUrl:k});case 15:return n=a.sent,a.abrupt("return",e(null,n));case 19:return a.prev=19,a.t0=a["catch"](5),a.abrupt("return",e(a.t0));case 22:case"end":return a.stop();}},a,null,[[5,19]])}));return function(){return a.apply(this,arguments)}}();exports.kakaoLoginCallback=kakaoLoginCallback;var postKakaoLogin=function(a,b){b.redirect(_routes["default"].home)};exports.postKakaoLogin=postKakaoLogin;var logout=function(a,b){a.logout(),b.redirect(_routes["default"].home),console.log("bye")};exports.logout=logout;var getMe=function(a,b){return b.render("userDetail",{pageTitle:"User Detail",user:a.user})};exports.getMe=getMe;var userDetail=/*#__PURE__*/function(){var a=(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function a(b,c){var d,e;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return d=b.params.id,a.prev=1,a.next=4,_User["default"].findById(d);case 4:return a.next=6,a.sent.populate("videos");case 6:e=a.sent,c.render("userDetail",{pageTitle:"User Detail",user:e}),a.next=13;break;case 10:a.prev=10,a.t0=a["catch"](1),c.redirect(_routes["default"].home);case 13:case"end":return a.stop();}},a,null,[[1,10]])}));return function(){return a.apply(this,arguments)}}();exports.userDetail=userDetail;var getEditProfile=function(a,b){return b.render("editProfile",{pageTitle:"Edit Profile"})};exports.getEditProfile=getEditProfile;var postEditProfile=/*#__PURE__*/function(){var a=(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function a(b,c){var d,e,f,g;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return d=b.body,e=d.name,f=d.email,g=b.file,a.prev=1,a.next=4,_User["default"].findByIdAndUpdate(b.user.id,{name:e,email:f,avatarUrl:g?g.location:b.user.avatarUrl});case 4:c.redirect(_routes["default"].me),a.next=10;break;case 7:a.prev=7,a.t0=a["catch"](1),c.redirect("/users/".concat(_routes["default"].editProfile));case 10:case"end":return a.stop();}},a,null,[[1,7]])}));return function(){return a.apply(this,arguments)}}();exports.postEditProfile=postEditProfile;var getChangePassword=function(a,b){return b.render("changePassword",{pageTitle:"Change Password"})};exports.getChangePassword=getChangePassword;var postChangePassword=/*#__PURE__*/function(){var a=(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function a(b,c){var d,e,f,g;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(d=b.body,e=d.oldPassword,f=d.newPassword,g=d.newPassword1,a.prev=1,f===g){a.next=6;break}return c.status(400),c.redirect("/users/".concat(_routes["default"].changePassword)),a.abrupt("return");case 6:return a.next=8,b.user.changePassword(e,f);case 8:c.redirect(_routes["default"].me),a.next=15;break;case 11:a.prev=11,a.t0=a["catch"](1),c.status(400),c.redirect("/users/".concat(_routes["default"].changePassword));case 15:case"end":return a.stop();}},a,null,[[1,11]])}));return function(){return a.apply(this,arguments)}}();exports.postChangePassword=postChangePassword;