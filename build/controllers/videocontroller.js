"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));require("core-js/modules/es6.object.define-property"),require("core-js/modules/es6.regexp.search"),Object.defineProperty(exports,"__esModule",{value:!0}),exports.postAddComment=exports.postRegisterView=exports.deleteVideo=exports.postEditVideo=exports.getEditVideo=exports.videoDetail=exports.postUpload=exports.getUpload=exports.video=exports.search=exports.home=void 0;require("core-js/modules/es6.array.find"),require("core-js/modules/es6.array.sort"),require("regenerator-runtime/runtime");var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),_routes=_interopRequireDefault(require("../routes")),_Video=_interopRequireDefault(require("../models/Video")),_Comment=_interopRequireDefault(require("../models/Comment")),home=/*#__PURE__*/function(){var a=(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function a(b,c){var d;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.prev=0,a.next=3,_Video["default"].find({}).sort({_id:-1});case 3:d=a.sent,c.render("home",{pageTitle:"Home",videos:d}),a.next=11;break;case 7:a.prev=7,a.t0=a["catch"](0),console.log(a.t0),c.render("home",{pageTitle:"Home",videos:[]});case 11:case"end":return a.stop();}},a,null,[[0,7]])}));return function(){return a.apply(this,arguments)}}();exports.home=home;//search
var search=/*#__PURE__*/function(){var a=(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function a(b,c){var d,e;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return d=b.query.term,e=[],a.prev=2,a.next=5,_Video["default"].find({title:{$regex:d,$options:"i"}});case 5:e=a.sent,a.next=11;break;case 8:a.prev=8,a.t0=a["catch"](2),console.log(a.t0);case 11:c.render("search",{pageTitle:"Search",searchingBy:d,videos:e});case 12:case"end":return a.stop();}},a,null,[[2,8]])}));return function(){return a.apply(this,arguments)}}();exports.search=search;var video=function(a,b){return b.render("video",{pageTitle:"Video"})};//upload
exports.video=video;var getUpload=function(a,b){return b.render("upload",{pageTitle:"Upload"})};exports.getUpload=getUpload;var postUpload=/*#__PURE__*/function(){var a=(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function a(b,c){var d,e,f,g,h;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return d=b.body,e=d.title,f=d.description,g=b.file.location,a.next=3,_Video["default"].create({fileUrl:g,title:e,description:f,creator:b.user.id});case 3:h=a.sent,b.user.videos.push(h.id),b.user.save(),c.redirect(_routes["default"].videoDetail(h.id));case 7:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}();//video detail
exports.postUpload=postUpload;var videoDetail=/*#__PURE__*/function(){var a=(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function a(b,c){var d,e;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return d=b.params.id,a.prev=1,a.next=4,_Video["default"].findById(d).populate("creator").populate("comments");case 4:e=a.sent,console.log(e),c.render("videoDetail",{pageTitle:e.title,video:e}),a.next=13;break;case 9:a.prev=9,a.t0=a["catch"](1),console.log(a.t0),c.redirect(_routes["default"].home);case 13:case"end":return a.stop();}},a,null,[[1,9]])}));return function(){return a.apply(this,arguments)}}();//edit video
exports.videoDetail=videoDetail;var getEditVideo=/*#__PURE__*/function(){var a=(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function a(b,c){var d,e;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return d=b.params.id,a.prev=1,a.next=4,_Video["default"].findById(d);case 4:if(e=a.sent,e.creator===b.user.id){a.next=9;break}throw Error();case 9:c.render("editVideo",{pageTitle:"Edit ".concat(e.title),video:e});case 10:a.next=16;break;case 12:a.prev=12,a.t0=a["catch"](1),c.redirect(_routes["default"].home),console.log(a.t0);case 16:case"end":return a.stop();}},a,null,[[1,12]])}));return function(){return a.apply(this,arguments)}}();exports.getEditVideo=getEditVideo;var postEditVideo=/*#__PURE__*/function(){var a=(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function a(b,c){var d,e,f,g;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return d=b.params.id,e=b.body,f=e.title,g=e.description,a.prev=1,a.next=4,_Video["default"].findOneAndUpdate({_id:d},{title:f,description:g});case 4:c.redirect(_routes["default"].videoDetail(d)),a.next=11;break;case 7:a.prev=7,a.t0=a["catch"](1),c.redirect(_routes["default"].home),console.log(a.t0);case 11:case"end":return a.stop();}},a,null,[[1,7]])}));return function(){return a.apply(this,arguments)}}();//delete video
exports.postEditVideo=postEditVideo;var deleteVideo=/*#__PURE__*/function(){var a=(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function a(b,c){var d;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(d=b.params.id,a.prev=1,video.creator===b.user.id){a.next=6;break}throw Error();case 6:return a.next=8,_Video["default"].findOneAndRemove({_id:d});case 8:a.next=13;break;case 10:a.prev=10,a.t0=a["catch"](1),console.log(a.t0);case 13:c.redirect(_routes["default"].home);case 14:case"end":return a.stop();}},a,null,[[1,10]])}));return function(){return a.apply(this,arguments)}}();// Register Video View
exports.deleteVideo=deleteVideo;var postRegisterView=/*#__PURE__*/function(){var a=(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function a(b,c){var d,e;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return d=b.params.id,a.prev=1,a.next=4,_Video["default"].findById(d);case 4:e=a.sent,e.views+=1,e.save(),c.status(200),a.next=13;break;case 10:a.prev=10,a.t0=a["catch"](1),c.status(400);case 13:return a.prev=13,c.end(),a.finish(13);case 16:case"end":return a.stop();}},a,null,[[1,10,13,16]])}));return function(){return a.apply(this,arguments)}}();// Add Comment
exports.postRegisterView=postRegisterView;var postAddComment=/*#__PURE__*/function(){var a=(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function a(b,c){var d,e,f,g,h;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return d=b.params.id,e=b.body.comment,f=b.user,a.prev=1,a.next=4,_Video["default"].findById(d);case 4:return g=a.sent,a.next=7,_Comment["default"].create({text:e,creator:f.id});case 7:h=a.sent,g.comments.push(h.id),g.save(),a.next=15;break;case 12:a.prev=12,a.t0=a["catch"](1),c.status(400);case 15:return a.prev=15,c.end(),a.finish(15);case 18:case"end":return a.stop();}},a,null,[[1,12,15,18]])}));return function(){return a.apply(this,arguments)}}();exports.postAddComment=postAddComment;